<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Audio Analzyer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #transcript, .response-area {
            width: 100%;
            height: 200px;
            margin-top: 0px;
            font-size: 16px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h1>Real-time Audio Analzyer</h1>
    <button id="startButton">Start Transcription</button>
    <button id="stopButton" disabled>Stop Transcription</button>
    <button onclick="copyTranscript()">Copy Transcript</button>
    <button onclick="document.getElementById('transcript').value='';">Clear Transcript</button>
    <BR><BR>
    
        <div class="control-group">
            <label for="showInterim">Show Interim Results:</label>
            <input type="checkbox" id="showInterim" checked>
            <span class="tooltip">Showing interim results provides immediate feedback but may be less accurate</span>
        </div>
        
        <div class="control-group">
            <label for="confidenceThreshold">Confidence Threshold:</label>
            <input type="range" id="confidenceThreshold" min="-1" max="1" step="0.00" value="0.05">
            <span id="confidenceValue">0.00</span>
            <span class="tooltip">Higher values mean only more confident transcriptions are shown</span>
        </div>
        <BR>
    <label>AI Model</label>
    <select id="modelSelect" class="select" width="100%">
    </select>
     
    <label>AI Analysis Time Delay</label>
    <select id="analysis_time_delay" class="select" width="100%">
        <option value="1000">10 Seconds</option>
        <option value="30000" selected>30 Seconds</option>
        <option value="60000">1 Minute</option>
        <option value="3600000">1 Hour</option>
    </select>
     
    <label for="language">Language</label>
    <select id="language" name="language">
        <option value="af">Afrikaans</option>
        <option value="sq">Albanian</option>
        <option value="am">Amharic</option>
        <option value="ar">Arabic</option>
        <option value="hy">Armenian</option>
        <option value="eu">Basque</option>
        <option value="bn">Bengali</option>
        <option value="bs">Bosnian</option>
        <option value="bg">Bulgarian</option>
        <option value="ca">Catalan</option>
        <option value="zh-CN">Chinese (Simplified)</option>
        <option value="zh-TW">Chinese (Traditional)</option>
        <option value="hr">Croatian</option>
        <option value="cs">Czech</option>
        <option value="da">Danish</option>
        <option value="nl">Dutch</option>
        <option value="en" selected>English</option>
        <option value="et">Estonian</option>
        <option value="fi">Finnish</option>
        <option value="fr">French</option>
        <option value="ka">Georgian</option>
        <option value="de">German</option>
        <option value="el">Greek</option>
        <option value="gu">Gujarati</option>
        <option value="ht">Haitian Creole</option>
        <option value="he">Hebrew</option>
        <option value="hi">Hindi</option>
        <option value="hu">Hungarian</option>
        <option value="is">Icelandic</option>
        <option value="id">Indonesian</option>
        <option value="ga">Irish</option>
        <option value="it">Italian</option>
        <option value="ja">Japanese</option>
        <option value="jw">Javanese</option>
        <option value="kn">Kannada</option>
        <option value="kk">Kazakh</option>
        <option value="km">Khmer</option>
        <option value="ko">Korean</option>
        <option value="ku">Kurdish (Kurmanji)</option>
        <option value="lv">Latvian</option>
        <option value="lt">Lithuanian</option>
        <option value="mk">Macedonian</option>
        <option value="ms">Malay</option>
        <option value="ml">Malayalam</option>
        <option value="mr">Marathi</option>
        <option value="mn">Mongolian</option>
        <option value="ne">Nepali</option>
        <option value="no">Norwegian</option>
        <option value="ps">Pashto</option>
        <option value="fa">Persian</option>
        <option value="pl">Polish</option>
        <option value="pt">Portuguese</option>
        <option value="pa">Punjabi</option>
        <option value="ro">Romanian</option>
        <option value="ru">Russian</option>
        <option value="sr">Serbian</option>
        <option value="si">Sinhala</option>
        <option value="sk">Slovak</option>
        <option value="sl">Slovenian</option>
        <option value="es">Spanish</option>
        <option value="sw">Swahili</option>
        <option value="sv">Swedish</option>
        <option value="ta">Tamil</option>
        <option value="te">Telugu</option>
        <option value="th">Thai</option>
        <option value="tr">Turkish</option>
        <option value="uk">Ukrainian</option>
        <option value="ur">Urdu</option>
        <option value="uz">Uzbek</option>
        <option value="vi">Vietnamese</option>
        <option value="cy">Welsh</option>
        <option value="xh">Xhosa</option>
        <option value="yi">Yiddish</option>
        <option value="yo">Yoruba</option>
        <option value="zu">Zulu</option>
    </select>

    <BR><BR>
    Raw Transcript
    <textarea id="transcript" readonly></textarea>
    
    <div class="interim-container">
        <h4>Interim Results</h4>
        <div id="interimDisplay" class="interim-text"></div>
    </div>

    <h2>AI Analysis</h2>
    <button onclick="sendToAI(document.getElementById('transcript').value);">Analyze Now</button>

    <BR>
        <BR>
    <label>AI API Response</label>
    <textarea id="aiAPIResponse" class="response-area" readonly></textarea>
    <BR>
    <label>Analyzed Transcript</label>
    <textarea id="fullTranscript" class="response-area" readonly></textarea>
    <BR>
    <label>Summary</label>
    <textarea id="summary" class="response-area" readonly></textarea>
    <BR>
    <label>Secrets</label>
    <textarea id="secrets" class="response-area" readonly></textarea>
    <BR>
    <label>Contradictions</label>
    <textarea id="contradictions" class="response-area" readonly></textarea>
    <BR>
    <label>Intent</label>
    <textarea id="intent" class="response-area" readonly></textarea>
    <BR>
    <label>Expected Response</label>
    <textarea id="expectedResponse" class="response-area" readonly></textarea>
    <BR>
    <label>Reward</label>
    <textarea id="reward" class="response-area" readonly></textarea>
    
    <script>
        function copyTranscript() {
            var copyText = document.getElementById("transcript");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(copyText.value);
        }

        function detectRepeatedPhrases(transcript) {
            const phrases = transcript.split('\n').filter(Boolean); // Split by newlines and filter out empty strings
            const phraseCounts = {};
            let repeatedPhrases = [];

            phrases.forEach(phrase => {
                if (phraseCounts[phrase]) {
                    phraseCounts[phrase]++;
                } else {
                    phraseCounts[phrase] = 1;
                }
            });

            // Collect phrases that appear more than once
            for (const phrase in phraseCounts) {
                if (phraseCounts[phrase] > 1) {
                    repeatedPhrases.push(phrase);
                }
            }
            return repeatedPhrases;
        }

        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const transcriptArea = document.getElementById('transcript');
        
        let recognition;
        let isRecognizing = false;
        let lastRequestTime = 0;

        function startTranscription() {
    if (!('webkitSpeechRecognition' in window)) {
        alert('Your browser does not support the Web Speech API.');
        return;
    }

    // Stop any existing recognition instance
    if (recognition) {
        recognition.stop();
    }

    recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true; // Always get interim results from the API
    recognition.lang = document.getElementById('language').value;

    // Get the interim results display preference
    const showInterim = document.getElementById('showInterim').checked;
    // Get confidence threshold if available
    const confidenceThreshold = parseFloat(document.getElementById('confidenceThreshold')?.value || 0);

    recognition.onresult = function(event) {
        console.log(event);
        
        let newTranscript = ''; // New transcript that we'll append to the textarea
        let interimTranscript = ''; // For storing interim results separately
        let currentTime = new Date().getTime();
        
        // Store the current value of the transcript
        lastTranscript = transcriptArea.value.trim();

        // Loop through all the results from the event object
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const result = event.results[i];
            const confidence = result[0].confidence;
            
            // Skip results with confidence below threshold
            if (confidence < confidenceThreshold) {
                continue;
            }
            
            if (result.isFinal) {
                // This is a final result
                let recognizedPhrase = result[0].transcript.trim();

                // Skip if the recognized phrase is empty
                if (!recognizedPhrase) {
                    continue;
                }

                // Check if this phrase has already been added
                const lastFewLines = lastTranscript.split('\n').slice(-3).join('\n');
                if (!lastFewLines.includes(recognizedPhrase)) {
                    // Append the new phrase to the transcript string
                    newTranscript += recognizedPhrase + '\n';

                    // Optional: Log the recognized phrase for debugging
                    console.log('Recognized (Final):', recognizedPhrase, 'Confidence:', confidence);
                }
            } else if (showInterim) {
                // This is an interim result, only add if user opted to show interim results
                let recognizedPhrase = result[0].transcript.trim();
                if (recognizedPhrase) {
                    interimTranscript += recognizedPhrase + ' ';
                    console.log('Interim:', recognizedPhrase, 'Confidence:', confidence);
                }
            }
        }

        // Update the textarea with the new transcript if there is one
        if (newTranscript) {
            transcriptArea.value += newTranscript;
        }
        
        // Display interim results in a separate element if enabled
        if (showInterim && document.getElementById('interimDisplay')) {
            document.getElementById('interimDisplay').textContent = interimTranscript;
        }

        // Auto-scroll to the bottom
        transcriptArea.scrollTop = transcriptArea.scrollHeight;

        // Check if enough time has passed to send the transcript for processing (AI, etc.)
        if (currentTime - lastRequestTime > parseInt(document.getElementById('analysis_time_delay').value)) {
            lastRequestTime = currentTime;
            sendToAI(transcriptArea.value); // Send to AI function
        }
    };

    // Rest of the function remains the same as before
    // Error handling, restart logic, etc.
    
    // Handle errors more gracefully with backoff retry
    let restartAttempts = 0;
    const maxRestartAttempts = 5;
    
    recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        
        // Different handling based on error type
        if (event.error === 'no-speech') {
            // No speech detected - just restart
            restartRecognition();
        } else if (event.error === 'audio-capture') {
            alert('Microphone error. Please check your microphone connection.');
            stopTranscription();
        } else if (event.error === 'network') {
            // Network error - try to restart with backoff
            if (restartAttempts < maxRestartAttempts) {
                setTimeout(() => {
                    restartRecognition();
                }, Math.pow(2, restartAttempts) * 1000); // Exponential backoff
                restartAttempts++;
            } else {
                alert('Network issues persistent. Please check your connection and try again.');
                stopTranscription();
            }
        } else if (event.error === 'not-allowed') {
            alert('Microphone access denied. Please allow microphone access to use transcription.');
            stopTranscription();
        } else {
            // Other errors - attempt to restart
            restartRecognition();
        }
    };

    // Automatically restart when recognition ends
    recognition.onend = function() {
        console.log('Speech recognition ended');
        if (isRecognizing) {
            restartRecognition();
        }
    };

    function restartRecognition() {
        if (isRecognizing) {
            try {
                setTimeout(() => {
                    recognition.start();
                    console.log('Restarted speech recognition');
                }, 500); // Small delay before restarting
            } catch (e) {
                console.error('Error restarting recognition:', e);
                stopTranscription();
            }
        }
    }

    try {
        recognition.start();
        isRecognizing = true;
        startButton.disabled = true;
        stopButton.disabled = false;
        restartAttempts = 0; // Reset restart attempts counter
        
        // Add a visual indicator that recording is active
        document.getElementById('status').textContent = 'Recording...';
        document.getElementById('status').style.color = 'red';
    } catch (e) {
        console.error('Error starting recognition:', e);
        //alert('Failed to start speech recognition. Please reload the page and try again.');
    }
}

// Add a proper stop function
function stopTranscription() {
    if (recognition) {
        recognition.stop();
    }
    isRecognizing = false;
    startButton.disabled = false;
    stopButton.disabled = true;
    
    // Update status indicator
    document.getElementById('status').textContent = 'Not recording';
    document.getElementById('status').style.color = 'black';
}

        function sendToAI(transcript) {
            fetch("https://proxy.small-recipe-9582.workers.dev/", {
                method: "POST",
                headers: {
                    "accept-language": "en-US,en;q=0.9",
                    "authorization": "Bearer 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",
                    "content-type": "application/json"
                },
                referrer: "https://www.avemariacloud.com/",
                referrerPolicy: "strict-origin-when-cross-origin",
                body: JSON.stringify({
                    model: document.getElementById("modelSelect").value,
                    messages: [
                        {
                            role: "system",
                            content: `I am interested in analyzing some transcription data

I am interested in creating a full word for word transcript, not a summary or analysis, of what has been said based on the transcription data.

I am interested in a summary.

I am interested in detecting secrets and/or contradictions. I am interested in a single sentence response.

I am interested in detecting the intent of the speaker. I am interested in a single sentence response.

I am interested in detecting the ideal response that this person is expecting. I am interested in a response that is consistent with a conversation. I am interested in a single sentence response.

I am interested in some sort of intellectual reward from this speech. I am interested in a single sentence response.

Respond in JSON with the labels: Full_Transcript, Summary, Secrets, Contradictions, Intent, Expected_Response, Reward.`
                        },
                        {
                            role: "user",
                            content: transcript
                        }
                    ],
                    response_format: { type: "json_object" }
                }),
                mode: "cors"
            })
            .then(response => response.json())
            .then(data => displayResponse(data))
            .catch(error => console.error('Error:', error));
        }

        function displayResponse(data) {

            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');

            const timeString = `${hours}:${minutes}:${seconds}`;
            console.log(timeString);

            console.log(data);

            data = data['choices'][0]['message']['content'];
            console.log(data);

            document.getElementById("aiAPIResponse").value = data;

            data = JSON.parse(data);

            document.getElementById("fullTranscript").value = data.Full_Transcript;

            document.getElementById("summary").value = "[" + timeString + "] " + data.Summary + `

` + document.getElementById("summary").value;

            document.getElementById("secrets").value = "[" + timeString + "] " + data.Secrets + `

` + document.getElementById("secrets").value;

            document.getElementById("contradictions").value = "[" + timeString + "] " + data.Contradictions + `

` + document.getElementById("contradictions").value;

            document.getElementById("intent").value = "[" + timeString + "] " + data.Intent + `

` + document.getElementById("intent").value;

            document.getElementById("expectedResponse").value = "[" + timeString + "] " + data.Expected_Response + `

` + document.getElementById("expectedResponse").value;

            document.getElementById("reward").value = "[" + timeString + "] " + data.Reward + `

` + document.getElementById("reward").value;
        }

        startButton.addEventListener('click', startTranscription);
        stopButton.addEventListener('click', stopTranscription);
    </script>

    <BR>
    <BR>

<div id="informationFooter" style="padding-left: 4em; padding-right: 4em;"></div>
<script src="https://www.avemariacloud.com/generic-loader.js"></script>

<script>

document.getElementById('language').addEventListener('change', function() {
    localStorage.setItem('selectedLanguage', this.value);
});

window.addEventListener('load', function() {
    const selectedLanguage = localStorage.getItem('selectedLanguage');
    if (selectedLanguage) {
        document.getElementById('language').value = selectedLanguage;
    }
});

</script>

<script>
    // Add this script to update the confidence threshold display
    document.getElementById('confidenceThreshold').addEventListener('input', function() {
        document.getElementById('confidenceValue').textContent = this.value;
    });
</script>

</body>
</html>
